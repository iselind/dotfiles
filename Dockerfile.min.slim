# Minimal "distroless-like" image that retains a shell (Debian slim final)
# - Builds Node globals and Go binaries in builders
# - Copies only the needed runtime files into a slim Debian final image

FROM node:20-slim AS node-builder
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates curl \
  && npm install -g diagnostic-languageserver pyright --prefix /usr/local \
  && npm --prefix /usr/local prune --production \
  && find /usr/local/lib/node_modules -type f -iname "*.md" -delete \
  && rm -rf /usr/local/lib/node_modules/*/test* /usr/local/lib/node_modules/*/docs* /usr/local/lib/node_modules/*/example* \
  && npm cache clean --force && apt-get clean && rm -rf /var/lib/apt/lists/*

FROM golang:1.24-bullseye AS go-builder
RUN set -eux; \
    GOBIN=/out go install golang.org/x/tools/cmd/goimports@latest; \
    GOBIN=/out go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest; \
  # Build Go tools we can (tflint is downloaded as a binary in its own stage)
    GOBIN=/out go install github.com/hashicorp/terraform-ls@latest; \
    # Install Go-based yq (preferred over python implementation)
    GOBIN=/out go install github.com/mikefarah/yq/v4@latest; \
    mkdir -p /out

ARG TERRAFORM_LS_VERSION=0.38.3

FROM debian:bookworm-slim AS terraformfetch
ARG TERRAFORM_VERSION=1.5.7
RUN set -eux; \
  apt-get update && apt-get install -y --no-install-recommends ca-certificates curl unzip xz-utils && rm -rf /var/lib/apt/lists/*; \
  TF_VER=${TERRAFORM_VERSION}; \
  TARBALL="terraform_${TF_VER}_linux_amd64.zip"; \
  URL="https://releases.hashicorp.com/terraform/${TF_VER}/${TARBALL}"; \
  curl -fsSL "$URL" -o /tmp/$TARBALL; \
  unzip /tmp/$TARBALL -d /tmp; \
  mkdir -p /out; \
  mv /tmp/terraform /out/terraform; \
  chmod +x /out/terraform

FROM debian:bookworm-slim AS shellfetch
RUN set -eux; \
  apt-get update && apt-get install -y --no-install-recommends ca-certificates curl xz-utils tar && rm -rf /var/lib/apt/lists/*; \
  SC_VER=0.11.0; TARBALL="shellcheck-v${SC_VER}.linux.x86_64.tar.xz"; \
  URL="https://github.com/koalaman/shellcheck/releases/download/v${SC_VER}/${TARBALL}"; \
  curl -fsSL "$URL" -o /tmp/$TARBALL; \
  tar -xJf /tmp/$TARBALL -C /tmp; \
  mkdir -p /out; \
  mv /tmp/shellcheck-v${SC_VER}/shellcheck /out/shellcheck; \
  chmod +x /out/shellcheck

FROM debian:bookworm-slim AS tflintfetch
ARG TFLINT_VERSION=0.60.0
RUN set -eux; \
  apt-get update && apt-get install -y --no-install-recommends ca-certificates curl unzip && rm -rf /var/lib/apt/lists/*; \
  TFLINT_VER=${TFLINT_VERSION}; \
  TARBALL="tflint_linux_amd64.zip"; \
  URL="https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VER}/${TARBALL}"; \
  curl -fsSL "$URL" -o /tmp/$TARBALL; \
  unzip /tmp/$TARBALL -d /tmp; \
  mkdir -p /out; \
  mv /tmp/tflint /out/tflint; \
  chmod +x /out/tflint

FROM debian:bookworm-slim AS final
ENV HOME=/home/ubuntu
ENV GOPATH=${HOME}/go
ENV PATH="${GOPATH}/bin:/usr/local/bin:/usr/bin:/bin"

RUN apt-get update \
  && apt-get install -y --no-install-recommends bash ca-certificates curl xz-utils \
    ripgrep jq tar unzip python3 python3-venv python3-pip \
    git make openssh-client \
    binutils \
  && apt-get clean && rm -rf /var/lib/apt/lists/*

# Copy node-installed global packages/binaries
COPY --from=node-builder /usr/local/lib/node_modules /usr/local/lib/node_modules
COPY --from=node-builder /usr/local/bin /usr/local/bin

# Copy Go-built binaries
COPY --from=go-builder /out/goimports /usr/local/bin/
COPY --from=go-builder /out/golangci-lint /usr/local/bin/
COPY --from=go-builder /out/yq /usr/local/bin/
COPY --from=tflintfetch /out/tflint /usr/local/bin/
COPY --from=go-builder /out/terraform-ls /usr/local/bin/
COPY --from=terraformfetch /out/terraform /usr/local/bin/

# Copy ShellCheck
COPY --from=shellfetch /out/shellcheck /usr/local/bin/shellcheck

## Install Python linters via Debian packages (avoids system pip installs / PEP 668)
RUN set -eux; \
  apt-get update; \
  apt-get install -y --no-install-recommends \
    python3-mypy \
    python3-flake8 \
    python3-autopep8 \
    python3-isort; \
  rm -rf /var/lib/apt/lists/*; \
  # Strip the Go-built and pulled binaries to save space (fail build if binaries are missing)
  strip /usr/local/bin/goimports; \
  strip /usr/local/bin/golangci-lint; \
  strip /usr/local/bin/shellcheck; \
  strip /usr/local/bin/terraform-ls; \
  strip /usr/local/bin/tflint; \
  strip /usr/local/bin/yq; \
  # Remove common noisy files from node globals (if any leftover)
  find /usr/local/lib/node_modules -type d \( -name test -o -name tests -o -name docs -o -name example -o -name coverage \) -prune -exec rm -rf {} +; \
  find /usr/local/lib/node_modules -type f \( -iname "*.md" -o -iname "license*" -o -iname "changelog*" -o -iname "readme*" \) -delete; \
  # purge strip tool and clean apt caches (only purge binutils if installed)
  dpkg -s binutils >/dev/null 2>&1 && apt-get purge -y --auto-remove binutils; \
  apt-get clean; rm -rf /var/lib/apt/lists/* /usr/share/doc/* /usr/share/man/* /usr/share/locale/*

# Create ubuntu user and home
RUN mkdir -p /home/ubuntu \
  && echo 'ubuntu:x:1001:1001:Ubuntu user:/home/ubuntu:/bin/bash' >> /etc/passwd \
  && echo 'ubuntu:x:1001:' >> /etc/group \
  && chown -R 1001:1001 /home/ubuntu

USER ubuntu
WORKDIR ${HOME}
CMD ["/bin/bash"]
